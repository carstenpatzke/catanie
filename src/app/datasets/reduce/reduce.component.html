<div fxLayout="row" fxLayout.xs="column">
  <div fxFlex="70%">
    <mat-card>
      <mat-card-header class="action-header">
        New Action
      </mat-card-header>

      <div class="details">
        <table>
          <tr>
            <th><mat-icon>info</mat-icon> Status</th>
            <td>
              <div *ngIf="result && result.hasOwnProperty('message')">
                {{ result.message }}
              </div>

              <div *ngIf="result && result.hasOwnProperty('errno')">
                Error reducing dataset: {{ result.code }}
              </div>

              <div
                *ngIf="
                  result &&
                  !result.hasOwnProperty('message') &&
                  !result.hasOwnProperty('errno') &&
                  datasetHistory
                "
              >
                <div *ngFor="let entry of datasetHistory">
                  <div
                    *ngIf="
                      entry.derivedDataset &&
                      datasetPids.includes(entry.derivedDataset.pid)
                    "
                  >
                    Previously derived dataset available.
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </table>
      </div>

      <div class="action-workflow">
        <mat-horizontal-stepper linear #stepper>
          <mat-step [stepControl]="formGroup">
            <ng-template matStepLabel>Select action</ng-template>
            <div class="action-selector">
              <mat-radio-group
                aria-label="Select an action"
                [(formControl)]="selectedAction"
                required
              >
                <mat-radio-button
                  *ngFor="let action of actions"
                  [value]="action"
                  >{{ action }}</mat-radio-button
                >
              </mat-radio-group>
            </div>
            <div>
              <button mat-stroked-button matStepperNext type="button">
                Next
              </button>
            </div>
          </mat-step>
          <mat-step [stepControl]="formGroup">
            <ng-template matStepLabel>Select script</ng-template>
            <div class="script-table">
              <table>
                <tr>
                  <td class="script-selector">
                    <div *ngIf="selectedAction.value === 'Reduce'">
                      <mat-form-field>
                        <mat-label>Reduce script</mat-label>
                        <mat-select [(formControl)]="selectedScript" required>
                          <mat-option
                            *ngFor="let script of reduceScripts"
                            [value]="script.value"
                            >{{ script.value }}</mat-option
                          >
                        </mat-select>
                        <mat-error *ngIf="selectedScript.hasError('required')">
                          Please choose a script
                        </mat-error>
                      </mat-form-field>
                    </div>
                    <div *ngIf="selectedAction.value === 'Analyze'">
                      <mat-form-field>
                        <mat-label>Analyze script</mat-label>
                        <mat-select [(formControl)]="selectedScript" required>
                          <mat-option
                            *ngFor="let script of analyzeScripts"
                            [value]="script.value"
                            >{{ script.value }}</mat-option
                          >
                        </mat-select>
                        <mat-error *ngIf="selectedScript.hasError('required')">
                          Please choose a script
                        </mat-error>
                      </mat-form-field>
                    </div>
                    <mat-divider [vertical]="true"></mat-divider>
                  </td>
                  <td class="script-details">
                    <h4>Description</h4>
                    <div *ngIf="selectedAction.value === 'Reduce'">
                      <div *ngFor="let script of reduceScripts">
                        <p *ngIf="script.value === selectedScript.value">
                          {{ script.description }}
                        </p>
                      </div>
                    </div>
                    <div *ngIf="selectedAction.value === 'Analyze'">
                      <div *ngFor="let script of analyzeScripts">
                        <p *ngIf="script.value === selectedScript.value">
                          {{ script.description }}
                        </p>
                      </div>
                    </div>
                    <p
                      *ngIf="
                        !selectedScript.value ||
                        !selectedScript.value.startsWith(
                          selectedAction.value.charAt(0)
                        )
                      "
                    >
                      Select a script to view description.
                    </p>
                  </td>
                </tr>
              </table>
            </div>
            <div>
              <button mat-stroked-button matStepperPrevious type="button">
                Back
              </button>
              <button mat-stroked-button matStepperNext type="button">
                Next
              </button>
            </div>
          </mat-step>
          <mat-step [stepControl]="formGroup">
            <ng-template matStepLabel>Confirm</ng-template>
            <div class="confirmation-table">
              <table>
                <tr>
                  <th>Action</th>
                  <td>{{ selectedAction.value }}</td>
                </tr>
                <tr>
                  <th>Script</th>
                  <td>{{ selectedScript.value }}</td>
                </tr>
              </table>
            </div>
            <div>
              <button mat-stroked-button matStepperPrevious type="button">
                Back
              </button>
              <button mat-stroked-button (click)="stepper.reset()">
                Reset
              </button>
              <button
                mat-flat-button
                color="primary"
                (click)="reduceDataset(dataset)"
              >
                Run Action
              </button>
            </div>
          </mat-step>
        </mat-horizontal-stepper>
      </div>
    </mat-card>

    <mat-card>
      <mat-card-header class="derived-header">
        Derived Datasets
      </mat-card-header>

      <div *ngIf="datasetHistory">
        <mat-table [dataSource]="datasetHistory" class="history-table">
          <!-- Column Definitions -->

          <!-- Timestamp Column -->
          <ng-container matColumnDef="timestamp">
            <mat-header-cell *matHeaderCellDef>
              <div fxLayout="column" style="align-items: center">
                <div>
                  <mat-icon>calendar_today</mat-icon>
                </div>
                <div>Creation Time</div>
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let entry">
              <div
                fxLayout="column"
                *ngIf="entry.hasOwnProperty('derivedDataset')"
              >
                {{
                  entry.derivedDataset.createdAt | date: "yyyy-MM-dd, EEE HH:mm"
                }}
              </div>
            </mat-cell>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef>
              <div fxLayout="column" style="align-items: center">
                <div>
                  <mat-icon>fingerprint</mat-icon>
                </div>
                <div>Name</div>
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let entry">
              {{ entry.derivedDataset.datasetName }}
            </mat-cell>
          </ng-container>

          <!-- Pid Column -->
          <ng-container matColumnDef="pid">
            <mat-header-cell *matHeaderCellDef>
              <div fxLayout="column" style="align-items: center">
                <div>
                  <mat-icon> perm_contact_calendar </mat-icon>
                </div>
                <div>PID</div>
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let entry">
              {{ entry.derivedDataset.pid }}
            </mat-cell>
          </ng-container>

          <!-- Software Column -->
          <ng-container matColumnDef="software">
            <mat-header-cell *matHeaderCellDef>
              <div fxLayout="column" style="align-items: center">
                <div>
                  <mat-icon> screen_share</mat-icon>
                </div>
                <div>Software Used</div>
              </div>
            </mat-header-cell>
            <mat-cell *matCellDef="let entry">
              {{ entry.derivedDataset.usedSoftware }}
            </mat-cell>
          </ng-container>

          <!-- End of Column Definitions -->

          <mat-header-row *matHeaderRowDef="columnsToDisplay"></mat-header-row>
          <mat-row
            *matRowDef="let entry; columns: columnsToDisplay"
            (click)="goTo(entry.derivedDataset)"
          >
          </mat-row>
        </mat-table>
      </div>
    </mat-card>
  </div>
</div>
